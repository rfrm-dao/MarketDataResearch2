name: Scheduled Python Script

on:
  schedule:
    - cron: '0 02 * * 5' 
  
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual run'
        required: false
        default: 'Manual trigger'
      
# ğŸ”‘ KEY FIX: The 'if' condition prevents the workflow from running if the 
# commit author is the GitHub Actions bot, thereby breaking the recursive loop.
jobs:
  run-script:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]' # â¬…ï¸ ADD THIS LINE HERE

    steps:
      # ... (Steps 1 through 5 remain unchanged) ...

      - name: â¬ Check out repository with PAT
        uses: actions/checkout@v2
        with:
          # Use GITHUB_TOKEN if it has repo access, but PAT is fine too
          token: ${{ secrets.PAT_TOKEN }} 

      - name: ğŸ› ï¸ Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade openpyxl pandas requests matplotlib
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: ğŸ§ª Verify OpenPyXL Installation
        run: python -c "import openpyxl; print('Openpyxl version:', openpyxl.__version__)"

      - name: ğŸš€ Run Python scripts
        run: |
          python BTCPrice.py
        # python ETHPrice.py
          
      # ğŸ“¤ Commit and Push Changes 
      # The git user.name and user.email are what identify the committer as 'GitHub Actions'
      - name: ğŸ“¤ Commit and Push Changes
        env:
          # Note: Using GITHUB_TOKEN is generally preferred for bot commits
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }} 
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git checkout main

          git add .
          # The commit message is what you see in the run history
          git commit -m "ğŸ”„ Automated update - $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git pull origin main --rebase || echo "Nothing to rebase"
          git push origin main
